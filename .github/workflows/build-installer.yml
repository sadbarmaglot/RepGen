name: Build Windows Installer v2

on:
  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ Ð² GitHub Actions
  workflow_dispatch:
    inputs:
      app_version:
        description: 'Ð’ÐµÑ€ÑÐ¸Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ (Ð¾ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ Ð¿ÑƒÑÑ‚Ñ‹Ð¼ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ)'
        required: false
        type: string
        default: ''
  
  # ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸ Ð¿ÑƒÑˆÐµ Ð² main Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ñ€ÐµÐ»Ð¸Ð·Ð½Ð¾Ð³Ð¾ Ñ‚ÐµÐ³Ð°
  push:
    branches: [ main ]
    tags:
      - 'v*'

jobs:
  build-installer:
    runs-on: windows-latest
    
    steps:
    - name: ðŸ§¹ Clean workspace
      run: |
        echo "ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‡ÑƒÑŽ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ..."
        if (Test-Path "build") { Remove-Item "build" -Recurse -Force }
        if (Test-Path "dist") { Remove-Item "dist" -Recurse -Force }
        if (Test-Path "*.spec") { Remove-Item "*.spec" -Force }
        echo "Ð Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð¾Ð±Ð»Ð°ÑÑ‚ÑŒ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½Ð°"
    
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ð²ÐµÑ€ÑÐ¸Ð¸ Ð¸Ð· Ñ‚ÐµÐ³Ð¾Ð²
        fetch-depth: 0
    
    - name: ðŸ”§ Setup Inno Setup
      run: |
        echo "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Inno Setup..."
        choco install innosetup -y
        echo "Inno Setup ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
    
    - name: ðŸ“Š Determine app version
      id: version
      shell: bash
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð±Ñ‹Ð»Ð° Ð»Ð¸ ÑƒÐºÐ°Ð·Ð°Ð½Ð° Ð²ÐµÑ€ÑÐ¸Ñ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
        if [ -n "${{ github.event.inputs.app_version }}" ]; then
          VERSION="${{ github.event.inputs.app_version }}"
          echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑƒÐºÐ°Ð·Ð°Ð½Ð½ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ: $VERSION"
        else
          # ÐŸÑ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¸Ð· git Ñ‚ÐµÐ³Ð°
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -n "$LATEST_TAG" ] && [[ $LATEST_TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€ÐµÑ„Ð¸ÐºÑ 'v' Ð¸Ð· Ñ‚ÐµÐ³Ð°
            VERSION=${LATEST_TAG#v}
            echo "ÐÐ°Ð¹Ð´ÐµÐ½ git Ñ‚ÐµÐ³: $LATEST_TAG, Ð²ÐµÑ€ÑÐ¸Ñ: $VERSION"
          else
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ .env Ñ„Ð°Ð¹Ð»
            if [ -f ".env" ]; then
              VERSION=$(grep -E '^APP_VERSION=' .env | cut -d'=' -f2 | tr -d '\r\n' || echo "")
            fi
            
            # Ð•ÑÐ»Ð¸ Ð²ÐµÑ€ÑÐ¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð´ÐµÑ„Ð¾Ð»Ñ‚Ð½ÑƒÑŽ
            if [ -z "$VERSION" ]; then
              VERSION="1.0.0"
              echo "Ð’ÐµÑ€ÑÐ¸Ñ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð´ÐµÑ„Ð¾Ð»Ñ‚Ð½ÑƒÑŽ: $VERSION"
            else
              echo "ÐÐ°Ð¹Ð´ÐµÐ½Ð° Ð²ÐµÑ€ÑÐ¸Ñ Ð² .env: $VERSION"
            fi
          fi
        fi
        
        echo "APP_VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ: $VERSION"
    
    - name: ðŸ“ Prepare build directory
      run: |
        echo "ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸ÐºÐ°..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ build/win ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
        if (-not (Test-Path "build\win")) {
          New-Item -ItemType Directory -Path "build\win" -Force
          echo "Ð¡Ð¾Ð·Ð´Ð°Ð½Ð° Ð¿Ð°Ð¿ÐºÐ° build\win"
        }
        
        # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ build/win (Ð´Ð»Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸)
        echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ build\win\ (Ð¿ÐµÑ€ÐµÐ´ ÑÐ±Ð¾Ñ€ÐºÐ¾Ð¹):"
        Get-ChildItem -Path "build\win" -Recurse | ForEach-Object { echo "  $($_.FullName)" }
    
    - name: ðŸ”¨ Build Windows application
      run: |
        echo "Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Windows Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
        
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Python Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        python --version
        pip --version
        
        # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
        echo "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
        pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ PyInstaller
        pyinstaller --version
        if ($LASTEXITCODE -ne 0) {
          echo "âŒ PyInstaller Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾!"
          exit 1
        }
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸
        if (-not (Test-Path "build\win")) {
          New-Item -ItemType Directory -Path "build\win" -Force
        }
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¸ Ð¿Ð°Ð¿Ð¾Ðº
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
        
        $requiredFiles = @("main.py", "settings.py", "requirements.txt")
        $requiredDirs = @("ui", "adapters", "common", "docx_generator", "assets")
        
        foreach ($file in $requiredFiles) {
          if (Test-Path $file) {
            echo "[OK] $file Ð½Ð°Ð¹Ð´ÐµÐ½"
          } else {
            echo "[ERROR] $file Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
            exit 1
          }
        }
        
        foreach ($dir in $requiredDirs) {
          if (Test-Path $dir) {
            echo "[OK] Ð¿Ð°Ð¿ÐºÐ° $dir Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
          } else {
            echo "[ERROR] Ð¿Ð°Ð¿ÐºÐ° $dir Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°!"
            exit 1
          }
        }
        
        echo "Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°"
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Python Ð¼Ð¾Ð´ÑƒÐ»Ð¸
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Python Ð¼Ð¾Ð´ÑƒÐ»Ð¸..."
        try {
          python -c "import tkinter; print('[OK] tkinter OK')"
        } catch {
          echo "[ERROR] tkinter Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ - ÑÑ‚Ð¾ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°!"
          exit 1
        }
        
        try {
          python -c "import PIL; print('[OK] PIL OK')"
        } catch {
          echo "[ERROR] PIL Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
          pip install Pillow
        }
        
        try {
          python -c "import openai; print('[OK] openai OK')"
        } catch {
          echo "[ERROR] openai Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
          exit 1
        }
        
        try {
          python -c "import requests; print('[OK] requests OK')"
        } catch {
          echo "[ERROR] requests Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
          exit 1
        }
        
        try {
          python -c "import docx; print('[OK] docx OK')"
        } catch {
          echo "[ERROR] docx Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
          exit 1
        }
        
        try {
          python -c "import trimesh; print('[OK] trimesh OK')"
        } catch {
          echo "[ERROR] trimesh Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
          exit 1
        }
        
        try {
          python -c "import numpy; print('[OK] numpy OK')"
        } catch {
          echo "[ERROR] numpy Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
          exit 1
        }
        
        echo "Ð’ÑÐµ Ð¼Ð¾Ð´ÑƒÐ»Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
        
        if (-not (Test-Path "assets\icon.ico")) {
          echo "[WARNING] assets\icon.ico Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð±ÐµÐ· Ð¸ÐºÐ¾Ð½ÐºÐ¸"
          $iconParam = ""
        } else {
          echo "[OK] Ð˜ÐºÐ¾Ð½ÐºÐ° Ð½Ð°Ð¹Ð´ÐµÐ½Ð°: assets\icon.ico"
          $iconParam = "--icon=assets\icon.ico"
        }
        
        # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· PyInstaller
        echo "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PyInstaller..."
        $pyinstallerArgs = @(
          "--onefile",
          "--windowed",
          "--name=DefectAnalyzer"
        )
        
        if ($iconParam) {
          $pyinstallerArgs += $iconParam
        }
        
        $pyinstallerArgs += @(
          "--add-data", "ui;ui",
          "--add-data", "common;common", 
          "--add-data", "docx_generator;docx_generator",
          "--add-data", "adapters;adapters",
          "--add-data", "assets;assets",
          "--add-data", "examples;examples",
          "--add-data", "settings.py;.",
          "--hidden-import=tkinter",
          "--hidden-import=tkinter.ttk",
          "--hidden-import=tkinter.messagebox",
          "--hidden-import=tkinter.filedialog",
          "--hidden-import=PIL",
          "--hidden-import=PIL.Image",
          "--hidden-import=PIL.ImageTk",
          "--hidden-import=openai",
          "--hidden-import=pathlib",
          "--hidden-import=threading",
          "--hidden-import=json",
          "--hidden-import=logging",
          "--hidden-import=requests",
          "--hidden-import=docx",
          "--hidden-import=dotenv",
          "--hidden-import=trimesh",
          "--hidden-import=numpy",
          "main.py"
        )
        
        echo "ÐÑ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ PyInstaller:"
        $pyinstallerArgs | ForEach-Object { echo "  $_" }
        
        echo "Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PyInstaller Ñ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¼ Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼..."
        
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð»Ð¾Ð³ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ PyInstaller
        $logFile = "pyinstaller.log"
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PyInstaller Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¾Ð¹
        & pyinstaller @pyinstallerArgs --log-level=DEBUG 2>&1 | Tee-Object -FilePath $logFile
        
        echo "PyInstaller Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ Ñ ÐºÐ¾Ð´Ð¾Ð¼: $LASTEXITCODE"
        
        # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð»Ð¾Ð³Ð°
        if (Test-Path $logFile) {
          echo "ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 50 ÑÑ‚Ñ€Ð¾Ðº Ð»Ð¾Ð³Ð° PyInstaller:"
          Get-Content $logFile -Tail 50 | ForEach-Object { echo "  $_" }
        }
        
        if ($LASTEXITCODE -ne 0) {
          echo "[ERROR] ÐžÑˆÐ¸Ð±ÐºÐ° PyInstaller! ÐšÐ¾Ð´ Ð²Ñ‹Ñ…Ð¾Ð´Ð°: $LASTEXITCODE"
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð»Ð¾Ð³Ð¸ Ð²Ñ‹ÑˆÐµ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹"
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸ dist ÐµÑÐ»Ð¸ Ð¾Ð½Ð° ÐµÑÑ‚ÑŒ
          if (Test-Path "dist") {
            echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ð¿Ð°Ð¿ÐºÐ¸ dist:"
            Get-ChildItem -Path "dist" -Recurse | ForEach-Object { echo "  $($_.FullName)" }
          }
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐ¸
          echo "Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐ¸:"
          Get-ChildItem -Path "." | ForEach-Object { echo "  $($_.Name)" }
          
          exit 1
        }
        
        echo "[OK] PyInstaller Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
        
        # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð² build/win
        if (Test-Path "dist\DefectAnalyzer.exe") {
          Copy-Item "dist\DefectAnalyzer.exe" "build\win\" -Force
          echo "[OK] DefectAnalyzer.exe ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð² build\win\"
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ„Ð°Ð¹Ð»Ðµ
          $fileInfo = Get-Item "build\win\DefectAnalyzer.exe"
          echo "Ð Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð°: $([math]::Round($fileInfo.Length / 1MB, 2)) MB"
        } else {
          echo "[ERROR] DefectAnalyzer.exe Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² Ð¿Ð°Ð¿ÐºÐµ dist\"
          exit 1
        }
    
    - name: ðŸ“ Update installer script version
      run: |
        echo "ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð² ÑÐºÑ€Ð¸Ð¿Ñ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸ÐºÐ°..."
        
        $version = "${{ steps.version.outputs.APP_VERSION }}"
        $issFile = "installer\windows\DefectAnalyzer.iss"
        
        if (Test-Path $issFile) {
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð² iss Ñ„Ð°Ð¹Ð»Ðµ
          $content = Get-Content $issFile -Raw
          echo "Ð˜ÑÑ…Ð¾Ð´Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ AppVersion: $version"
          
          $content = $content -replace '#define AppVersion "[^"]*"', "#define AppVersion `"$version`""
          
          # ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð¾Ñ‚ Ð½ÐµÐ´Ð¾Ð¿ÑƒÑÑ‚Ð¸Ð¼Ñ‹Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ð´Ð»Ñ VersionInfoVersion
          $cleanVersion = $version -replace '[^0-9.]', ''
          echo "ÐžÑ‡Ð¸Ñ‰ÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ: $cleanVersion"
          
          # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÐµÑ€ÑÐ¸ÑŽ Ð´Ð»Ñ VersionInfoVersion (Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ X.Y.Z.W)
          $versionParts = $cleanVersion -split '\.'
          if ($versionParts.Length -ge 3) {
            # Ð‘ÐµÑ€ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ðµ 3 Ñ‡Ð°ÑÑ‚Ð¸ Ð²ÐµÑ€ÑÐ¸Ð¸
            $major = if ($versionParts[0]) { $versionParts[0] } else { "0" }
            $minor = if ($versionParts[1]) { $versionParts[1] } else { "0" }
            $patch = if ($versionParts[2]) { $versionParts[2] } else { "0" }
            $versionInfoVersion = "$major.$minor.$patch.0"
          } else {
            $versionInfoVersion = "1.0.0.0"
          }
          
          echo "Ð¡Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ VersionInfoVersion: $versionInfoVersion"
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ VersionInfoVersion
          $currentVersionInfo = ($content | Select-String 'VersionInfoVersion=.*').Matches[0].Value
          echo "Ð¢ÐµÐºÑƒÑ‰ÐµÐµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ VersionInfoVersion: $currentVersionInfo"
          
          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ VersionInfoVersion
          $content = $content -replace 'VersionInfoVersion=.*', "VersionInfoVersion=$versionInfoVersion"
          
          # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð½Ð¾Ð²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ
          $newVersionInfo = ($content | Select-String 'VersionInfoVersion=.*').Matches[0].Value
          echo "ÐÐ¾Ð²Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ VersionInfoVersion: $newVersionInfo"
          
          Set-Content $issFile -Value $content -Encoding UTF8
          echo "[OK] Ð’ÐµÑ€ÑÐ¸Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð² $issFile Ð´Ð¾ $version"
          echo "[OK] VersionInfoVersion ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð° Ð² $versionInfoVersion"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ð»ÑÑ
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ Ñ„Ð°Ð¹Ð»Ð°:"
          $finalContent = Get-Content $issFile -Raw
          $finalVersionInfo = ($finalContent | Select-String 'VersionInfoVersion=.*').Matches[0].Value
          echo "Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ VersionInfoVersion: $finalVersionInfo"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð²ÐµÑ€ÑÐ¸Ñ Ð²Ð°Ð»Ð¸Ð´Ð½Ð° (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ†Ð¸Ñ„Ñ€Ñ‹ Ð¸ Ñ‚Ð¾Ñ‡ÐºÐ¸)
          if ($finalVersionInfo -match 'VersionInfoVersion=(\d+\.\d+\.\d+\.\d+)') {
            echo "[OK] VersionInfoVersion Ð¸Ð¼ÐµÐµÑ‚ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: $($matches[1])"
          } else {
            echo "[ERROR] VersionInfoVersion Ð¸Ð¼ÐµÐµÑ‚ Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: $finalVersionInfo"
            echo "ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð²Ð¾ÐºÑ€ÑƒÐ³ VersionInfoVersion:"
            $context = ($finalContent | Select-String -Pattern 'VersionInfoVersion=.*' -Context 2,2).Line
            $context | ForEach-Object { echo "  $_" }
          }
        } else {
          echo "[ERROR] Ð¤Ð°Ð¹Ð» $issFile Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
          exit 1
        }
    
    - name: ðŸ”§ Compile installer with Inno Setup
      run: |
        echo "ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Inno Setup..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ iss Ñ„Ð°Ð¹Ð»Ð° Ð¿ÐµÑ€ÐµÐ´ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸ÐµÐ¹
        $issFile = "installer\windows\DefectAnalyzer.iss"
        if (Test-Path $issFile) {
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ $issFile Ð¿ÐµÑ€ÐµÐ´ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸ÐµÐ¹:"
          $content = Get-Content $issFile -Raw
          $versionInfo = ($content | Select-String 'VersionInfoVersion=.*').Matches[0].Value
          echo "VersionInfoVersion Ð² Ñ„Ð°Ð¹Ð»Ðµ: $versionInfo"
          
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²Ð°Ð»Ð¸Ð´Ð½Ð¾ÑÑ‚ÑŒ
          if ($versionInfo -match 'VersionInfoVersion=(\d+\.\d+\.\d+\.\d+)') {
            echo "[OK] VersionInfoVersion Ð²Ð°Ð»Ð¸Ð´Ð½Ð°: $($matches[1])"
          } else {
            echo "[ERROR] VersionInfoVersion Ð½ÐµÐ²Ð°Ð»Ð¸Ð´Ð½Ð°: $versionInfo"
            echo "ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð²Ð¾ÐºÑ€ÑƒÐ³ VersionInfoVersion:"
            $lines = Get-Content $issFile
            for ($i = 0; $i -lt $lines.Length; $i++) {
              if ($lines[$i] -match 'VersionInfoVersion') {
                echo "Ð¡Ñ‚Ñ€Ð¾ÐºÐ° $($i+1): $($lines[$i])"
                if ($i -gt 0) { echo "Ð¡Ñ‚Ñ€Ð¾ÐºÐ° $($i): $($lines[$i-1])" }
                if ($i -lt $lines.Length-1) { echo "Ð¡Ñ‚Ñ€Ð¾ÐºÐ° $($i+2): $($lines[$i+1])" }
                break
              }
            }
          }
        }
        
        $issFile = "installer\windows\DefectAnalyzer.iss"
        $isccPath = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
        
        if (-not (Test-Path $isccPath)) {
          $isccPath = "${env:ProgramFiles}\Inno Setup 6\ISCC.exe"
        }
        
        if (-not (Test-Path $isccPath)) {
          echo "[ERROR] ISCC.exe Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½! ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÑƒ Inno Setup"
          Get-ChildItem -Path "${env:ProgramFiles}" -Filter "*Inno*" -Recurse
          Get-ChildItem -Path "${env:ProgramFiles(x86)}" -Filter "*Inno*" -Recurse
          exit 1
        }
        
        echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ISCC: $isccPath"
        echo "ÐšÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€ÑƒÐµÐ¼: $issFile"
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸ÑŽ
        & $isccPath $issFile
        
        if ($LASTEXITCODE -eq 0) {
          echo "[OK] Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐºÐ¾Ð¼Ð¿Ð¸Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½!"
        } else {
          echo "[ERROR] ÐžÑˆÐ¸Ð±ÐºÐ° ÐºÐ¾Ð¼Ð¿Ð¸Ð»ÑÑ†Ð¸Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸ÐºÐ°!"
          exit 1
        }
    
    - name: ðŸ“‹ List generated files
      run: |
        echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ dist (ÑÑ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð°Ñ Ð´Ð»Ñ Inno Setup)
        if (Test-Path "dist") {
          echo "Ð¤Ð°Ð¹Ð»Ñ‹ Ð² Ð¿Ð°Ð¿ÐºÐµ dist:"
          Get-ChildItem -Path "dist" | ForEach-Object { echo "  - $($_.Name) ($($_.Length) bytes)" }
        } else {
          echo "âš ï¸ ÐŸÐ°Ð¿ÐºÐ° dist Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°"
        }
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ð°Ð¿ÐºÑƒ installer (ÐµÑÐ»Ð¸ OutputDir Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½)
        if (Test-Path "installer") {
          echo "Ð¤Ð°Ð¹Ð»Ñ‹ Ð² Ð¿Ð°Ð¿ÐºÐµ installer:"
          Get-ChildItem -Path "installer" -Recurse | ForEach-Object { echo "  - $($_.FullName)" }
        }
        
        # Ð˜Ñ‰ÐµÐ¼ setup Ñ„Ð°Ð¹Ð»Ñ‹ Ð² ÐºÐ¾Ñ€Ð½Ðµ
        $setupFiles = Get-ChildItem -Path "." -Filter "Setup-*.exe" -Recurse
        if ($setupFiles.Count -gt 0) {
          echo "ÐÐ°Ð¹Ð´ÐµÐ½Ð½Ñ‹Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸ÐºÐ¸:"
          $setupFiles | ForEach-Object { echo "  - $($_.FullName) ($($_.Length) bytes)" }
        }
    
    - name: ðŸ“¦ Upload installer artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-installer
        path: |
          dist/*.exe
          Setup-*.exe
        retention-days: 30
    
    - name: ðŸ“Š Build summary
      run: |
        echo "=========================================="
        echo "ðŸ—ï¸ Ð¡Ð‘ÐžÐ ÐšÐ Ð£Ð¡Ð¢ÐÐÐžÐ’Ð©Ð˜ÐšÐ Ð—ÐÐ’Ð•Ð Ð¨Ð•ÐÐ"
        echo "=========================================="
        echo "Ð’ÐµÑ€ÑÐ¸Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ: ${{ steps.version.outputs.APP_VERSION }}"
        echo "Git commit: ${{ github.sha }}"
        echo "Git ref: ${{ github.ref }}"
        echo "=========================================="
        echo ""
        echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ñ‰Ð¸Ðº Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ ÐºÐ°Ðº Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚ 'windows-installer'"
        echo "ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð² Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ 'Actions' -> 'Artifacts'"
        echo ""
        echo "ðŸ”§ Ð”Ð»Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸:"
        echo "1. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Inno Setup"
        echo "2. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ installer/windows/DefectAnalyzer.iss"
        echo "3. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ F9 Ð¸Ð»Ð¸ Build -> Compile"
        echo ""
        echo "=========================================="
